<!DOCTYPE html>
<html class="ready" lang="en"><head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="shenma-site-verification" content="8a69823d7371d1eec4379853d25200cd_1448504990"> 
    <title>Snail Jie . Blog</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <link href="/feed.xml" rel="alternate" title="Snail Jie . Blog Atom feed" type="application/atom+xml">
    <link href="/css/screen.css" rel="stylesheet">
    <!--[if lt IE 9]>
      <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/r29/html5.js"></script>
    <![endif]-->
    <link href="/favicon.ico" rel="shortcut icon">

</head>

  <body class="blog index">
    <header class="navbar navbar-fixed-top" id="banner" role="banner">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-target=".nav-collapse" data-toggle="collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="/">
            <span class="logo"></span>
            <span class="name">ksoong</span>
          </a>
          <nav class="nav-collapse" role="navigation">
            <ul class="nav">
              <li><a href="/">Home</a></li>
	      <!--
              <li><a href="/lab">Labs</a></li>
              <li><a href="/blog/">Blog</a></li>
	      -->
	      <li><a href="/books">Books</a></li>
              <li><a href="/archive">Archives</a></li>
              <li><a href="/slide">Slides</a></li>
              <li><a href="/about">About</a></li>
            </ul>
          </nav>
        </div>
      </div>
    </header>
    <div style="min-height: 250px;" id="main" role="main">
      
<div id="content-header">
        <div class="container">
         <h1>
              <a href="/blog">Blog</a>
              <!--a href="#">&raquo;</a>
              <a href="/teiid-dqp">Understanding Teiid Engine</a-->
          </h1>
        </div>
</div>
      <div class="container">
        <div id="content">
          
<h2 class="title">
                 <a class="post-link" href="/teiid-dqp">Understanding Teiid Engine</a>
              </h2>
 
<header class="post">
              <div class="byline">
                <span class="author">Posted by
                <a href="/about">Kylin Soong</a> on</span>
                <span class="dateinline">May 26, 2015</span>
		<i class="icon-tags"></i> categorized as <a class="tag" href="/categories/teiid">teiid</a>
              </div>
            </header>

 
<ul id="markdown-toc">
  <li><a href="#dqpcore" id="markdown-toc-dqpcore">DQPCore</a>    <ul>
      <li><a href="#dqpcore-start" id="markdown-toc-dqpcore-start">DQPCore start</a>        <ul>
          <li><a href="#temptabledatamanager-initialize" id="markdown-toc-temptabledatamanager-initialize">TempTableDataManager initialize</a></li>
        </ul>
      </li>
      <li><a href="#dqpcores-executequery-method" id="markdown-toc-dqpcores-executequery-method">DQPCore’s executeQuery() method</a></li>
      <li><a href="#dqpworkcontext" id="markdown-toc-dqpworkcontext">DQPWorkContext</a></li>
    </ul>
  </li>
  <li><a href="#request" id="markdown-toc-request">Request</a></li>
  <li><a href="#metadata" id="markdown-toc-metadata">Metadata</a>    <ul>
      <li><a href="#system-metadata" id="markdown-toc-system-metadata">System Metadata</a></li>
      <li><a href="#metadata-load-example" id="markdown-toc-metadata-load-example">Metadata Load Example</a></li>
    </ul>
  </li>
  <li><a href="#process-of-generate-a-processorplan" id="markdown-toc-process-of-generate-a-processorplan">Process of generate a ProcessorPlan</a>    <ul>
      <li><a href="#parsing---validate-sql-syntax-and-convert-to-internal-form" id="markdown-toc-parsing---validate-sql-syntax-and-convert-to-internal-form"><strong>1. Parsing</strong> - validate SQL syntax and convert to internal form.</a></li>
      <li><a href="#resolving---link-all-identifiers-to-metadata-and-functions-to-the-function-library" id="markdown-toc-resolving---link-all-identifiers-to-metadata-and-functions-to-the-function-library"><strong>2. Resolving</strong> - link all identifiers to metadata and functions to the function library</a></li>
      <li><a href="#validating---validate-sql-semantics-based-on-metadata-references-and-type-signatures" id="markdown-toc-validating---validate-sql-semantics-based-on-metadata-references-and-type-signatures"><strong>3. Validating</strong> - validate SQL semantics based on metadata references and type signatures.</a></li>
      <li><a href="#rewriting---rewrite-sql-to-simplify-expressions-and-criteria" id="markdown-toc-rewriting---rewrite-sql-to-simplify-expressions-and-criteria"><strong>4. Rewriting</strong> - rewrite SQL to simplify expressions and criteria</a></li>
      <li><a href="#optimizing---the-logical-plan-and-processor-plan" id="markdown-toc-optimizing---the-logical-plan-and-processor-plan"><strong>5. Optimizing</strong> - the logical plan and processor plan</a>        <ul>
          <li><a href="#generate-canonical-plan" id="markdown-toc-generate-canonical-plan">Generate canonical plan</a></li>
          <li><a href="#optimization" id="markdown-toc-optimization">Optimization</a></li>
          <li><a href="#plan-to-process-converter" id="markdown-toc-plan-to-process-converter">Plan to process converter</a></li>
        </ul>
      </li>
      <li><a href="#plannode" id="markdown-toc-plannode">PlanNode</a></li>
    </ul>
  </li>
  <li><a href="#batchcollector" id="markdown-toc-batchcollector">BatchCollector</a>    <ul>
      <li><a href="#process-system-query" id="markdown-toc-process-system-query">Process System Query</a></li>
      <li><a href="#blockedexception" id="markdown-toc-blockedexception">BlockedException</a></li>
    </ul>
  </li>
  <li><a href="#requestworkitem" id="markdown-toc-requestworkitem">RequestWorkItem</a>    <ul>
      <li><a href="#threads-in-teiid-engine" id="markdown-toc-threads-in-teiid-engine">Threads in Teiid Engine</a></li>
      <li><a href="#send-results-if-needed" id="markdown-toc-send-results-if-needed">send Results If Needed</a></li>
      <li><a href="#threadstate-change-change-in-request-processing" id="markdown-toc-threadstate-change-change-in-request-processing">ThreadState Change Change in Request Processing</a></li>
    </ul>
  </li>
</ul>

<h2 id="dqpcore">DQPCore</h2>

<p>DQPCore is the entry point of Teiid Engine Procesing, it implement the client interface <a href="http://ksoong.org/teiid-uml-diagram#orgteiidclientdqp">DQP</a>. A client JDBC query will first go into</p>

<div class="highlighter-rouge"><pre class="highlight"><code>ResultsFuture&lt;ResultsMessage&gt; executeRequest(long reqID, RequestMessage message) throws TeiidProcessingException, TeiidComponentException;
</code></pre>
</div>

<p>If debug the DQPCore, set a breakpoint to this method is smart way.</p>

<h3 id="dqpcore-start">DQPCore start</h3>

<p>The DQPCore start initialize lots of necessary components which used in Teiid Engine, it mainly including BufferManager initialize, <a href="http://ksoong.org/teiid-uml-diagram#orgteiidqueryprocessorprocessordatamanager">TempTableDataManager</a> initialize etc.</p>

<h4 id="temptabledatamanager-initialize">TempTableDataManager initialize</h4>

<p><a href="http://ksoong.org/teiid-uml-diagram#orgteiidqueryprocessorprocessordatamanager">TempTableDataManager</a> is used to handle temporary tables, What temporary tables are defined in <a href="#System Metadata">System Metadata</a>. <a href="http://ksoong.org/teiid-uml-diagram#orgteiidqueryprocessorprocessordatamanager">TempTableDataManager</a> initialize need a <code class="highlighter-rouge">DataTierManagerImpl</code> as blow code:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>DataTierManagerImpl processorDataManager = new DataTierManagerImpl(this, this.bufferManager, this.config.isDetectingChangeEvents());
processorDataManager.setEventDistributor(eventDistributor);
dataTierMgr = new TempTableDataManager(processorDataManager, this.bufferManager, this.rsCache);
</code></pre>
</div>

<p>In DataTierManagerImpl’s constructor method, all systemTables and systemAdminTables be load to memory, it including SystemTables:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>VIRTUALDATABASES,
SCHEMAS,
TABLES,
DATATYPES,
COLUMNS,
KEYS,
PROCEDURES,
KEYCOLUMNS,
PROCEDUREPARAMS,
REFERENCEKEYCOLUMNS,
PROPERTIES,
FUNCTIONS,
FUNCTIONPARAMS,
</code></pre>
</div>

<p>and SystemAdminTables:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>MATVIEWS,
VDBRESOURCES,
TRIGGERS,
VIEWS,
STOREDPROCEDURES,
USAGE
</code></pre>
</div>

<p>Each Tables represent by a RecordExtractionTable</p>

<p><img src="/assets/blog/teiid/teiid-dqp-RecordExtractionTable.png" alt="RecordExtractionTable" /></p>

<p>The RecordTable looks</p>

<p><img src="/assets/blog/teiid/teiid-dqp-RecordTable.png" alt="RecordTable" /></p>

<h3 id="dqpcores-executequery-method">DQPCore’s executeQuery() method</h3>

<p>DQPCore supply a static public method executeQuery(), which used to execute the given query asynchly.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>public static ResultsFuture&lt;?&gt; executeQuery(final String command
        , final VDBMetaData vdb
        , final String user
	, final String app
	, final long timeoutInMilli
	, final DQPCore engine
	, final ResultsListener listener) throws Throwable
</code></pre>
</div>

<h3 id="dqpworkcontext">DQPWorkContext</h3>

<p>DQPWorkContext is ThreadLocal variable, its mainly supply functionalities including:</p>

<ul>
  <li>keep all Session, connection information related information before Request be transfer to Processing Threads.</li>
  <li>Supply the interface to run <code class="highlighter-rouge">Callable</code> and <code class="highlighter-rouge">Runnable</code> task.</li>
</ul>

<p>DQPWorkContext run <code class="highlighter-rouge">Callable</code> example:</p>

<p><img src="/assets/blog/teiid/teiid-seq-DQPWorkContext.png" alt="DQPWorkContext run Callable" /></p>

<h2 id="request">Request</h2>

<p>Once the client SQL query be passed to Teiid Engine(DQPCore), it first be formed as a <code class="highlighter-rouge">org.teiid.dqp.internal.process.Request</code> Object, which is the Server side representation of the RequestMessage, the UML diagram of Request:</p>

<p><img src="/assets/blog/teiid-dqp-process-request.png" alt="Request UML" /></p>

<ul>
  <li><code class="highlighter-rouge">processRequest()</code> is the key operation method, which invoked by RequestWorkItem. This method will finally create <code class="highlighter-rouge">org.teiid.query.processor.QueryProcessor</code>, which wrappered a <code class="highlighter-rouge">org.teiid.query.processor.ProcessorPlan</code>(Refer to <a href="#Process of generate a ProcessorPlan">Process of generate a ProcessorPlan</a> for more details).</li>
  <li><code class="highlighter-rouge">TempTableStore</code> - TempTableStores are transanctional, but do not act as full resource manager. This means we are effectively 1PC and don’t allow any heuristic exceptions on commit. Table state snapshoting and a <code class="highlighter-rouge">javax.transaction.Synchronization</code> are used to perform the appropriate commit/rollback actions.</li>
</ul>

<blockquote>
  <p>NOTE: refer to <a href="http://ksoong.org/javaee/2016/01/20/jta-api-examples/#synchronization">link</a> for more about JTA Synchronization.</p>
</blockquote>

<ul>
  <li><code class="highlighter-rouge">QueryMetadataInterface</code> - UML diagram refer to <a href="http://ksoong.org/teiid-uml-diagram/#orgteiidquerymetadataquerymetadatainterface">link</a>, refer to <strong>Metadata Load Example</strong> below for more details.</li>
  <li><code class="highlighter-rouge">ProcessorDataManager</code> - UML diagram refer to <a href="http://ksoong.org/teiid-uml-diagram/#orgteiidqueryprocessorprocessordatamanager">link</a></li>
</ul>

<h2 id="metadata">Metadata</h2>

<h3 id="system-metadata">System Metadata</h3>

<p>Each time a VDB is uping, <code class="highlighter-rouge">org.teiid.query.metadata.SystemMetadata</code> will load the system Metadata in advance, with the following sequence:</p>

<ol>
  <li><a href="https://raw.githubusercontent.com/teiid/teiid/master/engine/src/main/resources/org/teiid/metadata/types.dat">types.dat</a> - define all supported datatypes</li>
  <li><a href="https://raw.githubusercontent.com/teiid/teiid/master/engine/src/main/resources/org/teiid/metadata/SYS.sql">SYS.sql</a> - Contain <strong>System Tables:</strong> Columns, DataTypes, KeyColumns, Keys, ProcedureParams, Procedures, FunctionParams, Functions, Properties, ReferenceKeyColumns, Schemas, Tables, VirtualDatabases; <strong>System Procedures:</strong> getXMLSchemas, ARRAYITERATE; <strong>System Views:</strong> spatial_ref_sys, GEOMETRY_COLUMNS</li>
  <li><a href="https://raw.githubusercontent.com/teiid/teiid/master/engine/src/main/resources/org/teiid/metadata/SYSADMIN.sql">SYSADMIN.sql</a> - Contain <strong>Tables:</strong> Usage, MatViews, VDBResources, Triggers, Views, StoredProcedures; <strong>Procedures:</strong> isLoggable, logMsg, refreshMatView, refreshMatViewRow, refreshMatViewRows, setColumnStats, setProperty, setTableStats, matViewStatus, loadMatView, updateMatView</li>
</ol>

<h3 id="metadata-load-example">Metadata Load Example</h3>

<p><code class="highlighter-rouge">customer.ddl</code> under classpath, this example demonstrates how to load metadata in <code class="highlighter-rouge">customer.ddl</code>, with <code class="highlighter-rouge">QueryMetadataInterface</code>, the sample code looks as below:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">VDBMetaData</span> <span class="n">vdb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">VDBMetaData</span><span class="o">();</span>
<span class="n">vdb</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"ExampleVDB"</span><span class="o">);</span>
<span class="n">vdb</span><span class="o">.</span><span class="na">setVersion</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
<span class="n">Properties</span> <span class="n">p</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Properties</span><span class="o">();</span>
<span class="n">QueryParser</span> <span class="n">parser</span> <span class="o">=</span> <span class="k">new</span> <span class="n">QueryParser</span><span class="o">();</span>
        
<span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Datatype</span><span class="o">&gt;</span> <span class="n">typeMap</span> <span class="o">=</span> <span class="n">SystemMetadata</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">getRuntimeTypeMap</span><span class="o">();</span>
        
<span class="n">ModelMetaData</span> <span class="n">mmd</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ModelMetaData</span><span class="o">();</span>
<span class="n">mmd</span><span class="o">.</span><span class="na">setName</span><span class="o">(</span><span class="s">"ExampleMode"</span><span class="o">);</span>
<span class="n">vdb</span><span class="o">.</span><span class="na">addModel</span><span class="o">(</span><span class="n">mmd</span><span class="o">);</span>
<span class="n">MetadataFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MetadataFactory</span><span class="o">(</span><span class="n">vdb</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">vdb</span><span class="o">.</span><span class="na">getVersion</span><span class="o">(),</span> <span class="s">"ExampleMode"</span><span class="o">,</span> <span class="n">typeMap</span><span class="o">,</span> <span class="n">p</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
<span class="n">parser</span><span class="o">.</span><span class="na">parseDDL</span><span class="o">(</span><span class="n">factory</span><span class="o">,</span> <span class="n">loadReader</span><span class="o">(</span><span class="s">"customer.ddl"</span><span class="o">));</span>
<span class="n">MetadataStore</span> <span class="n">systemStore</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="na">asMetadataStore</span><span class="o">();</span>
     
<span class="n">TransformationMetadata</span> <span class="n">tm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TransformationMetadata</span><span class="o">(</span><span class="n">vdb</span><span class="o">,</span> <span class="k">new</span> <span class="n">CompositeMetadataStore</span><span class="o">(</span><span class="n">systemStore</span><span class="o">),</span> <span class="kc">null</span><span class="o">,</span> <span class="k">new</span> <span class="n">SystemFunctionManager</span><span class="o">(</span><span class="n">typeMap</span><span class="o">).</span><span class="na">getSystemFunctions</span><span class="o">(),</span> <span class="kc">null</span><span class="o">);</span>
<span class="n">vdb</span><span class="o">.</span><span class="na">addAttchment</span><span class="o">(</span><span class="n">QueryMetadataInterface</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">tm</span><span class="o">);</span>
<span class="n">MetadataValidator</span> <span class="n">validator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MetadataValidator</span><span class="o">(</span><span class="n">typeMap</span><span class="o">,</span> <span class="n">parser</span><span class="o">);</span>
<span class="n">ValidatorReport</span> <span class="n">report</span> <span class="o">=</span> <span class="n">validator</span><span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">vdb</span><span class="o">,</span> <span class="n">systemStore</span><span class="o">);</span>
<span class="k">if</span> <span class="o">(</span><span class="n">report</span><span class="o">.</span><span class="na">hasItems</span><span class="o">())</span> <span class="o">{</span>
   <span class="k">throw</span> <span class="k">new</span> <span class="n">TeiidRuntimeException</span><span class="o">(</span><span class="n">report</span><span class="o">.</span><span class="na">getFailureMessage</span><span class="o">());</span>
<span class="o">}</span>
</code></pre>
</div>

<h2 id="process-of-generate-a-processorplan">Process of generate a ProcessorPlan</h2>

<p><img src="/assets/blog/teiid-seq-pregeneratePlan.png" alt="Pre generate ProcessorPlan" /></p>

<p>As above figure, assuming a JDBC client execute SQL</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">ID</span><span class="p">,</span> <span class="n">SYMBOL</span><span class="p">,</span> <span class="n">COMPANY_NAME</span> <span class="k">FROM</span> <span class="n">Product</span>
</code></pre>
</div>

<p>When the query engine receives an incoming SQL query, it be processed to Request’s generatePlan() method, this method will create a ProcessorPlan(<a href="http://ksoong.org/teiid-uml-diagram#orgteiidqueryprocessorprocessorplan">UML diagram</a>), which is a set of instructions created by a query engine for executing a command submitted by a user or application. The purpose of the query plan is to execute the user’s query in as efficient a way as possible.</p>

<p>In this section, we will focus on the process of generate a ProcessorPlan, it performs the following operations:</p>

<h3 id="parsing---validate-sql-syntax-and-convert-to-internal-form"><strong>1. Parsing</strong> - validate SQL syntax and convert to internal form.</h3>

<p>SQL come from <code class="highlighter-rouge">RequestMessage</code> which transited from Client. ThreadLocal QueryParser has a parseCommand() method, which can parse SQL String to internal form, eg, <code class="highlighter-rouge">org.teiid.query.sql.lang.Command</code>, refer to <a href="http://ksoong.org/teiid-query-sql-api">link</a> for more forms.</p>

<blockquote>
  <p>NOTE: QueryParser has a javacc <a href="https://raw.githubusercontent.com/teiid/teiid/master/engine/src/main/javacc/org/teiid/query/parser/SQLParser.jj">SQLParser.jj</a> based SQLParser, the parse result is a Command Object.</p>
</blockquote>

<h3 id="resolving---link-all-identifiers-to-metadata-and-functions-to-the-function-library"><strong>2. Resolving</strong> - link all identifiers to metadata and functions to the function library</h3>

<p>The <code class="highlighter-rouge">QueryResolver</code> is used between Parsing and QueryValidation,</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">QueryResolver</span><span class="o">.</span><span class="na">resolveCommand</span><span class="o">(</span><span class="n">command</span><span class="o">,</span> <span class="n">metadata</span><span class="o">);</span>
</code></pre>
</div>

<p>QueryResolver contains a series of <code class="highlighter-rouge">CommandResolver</code>(<a href="http://ksoong.org/teiid-uml-diagram#orgteiidqueryresolvercommandresolver">UML</a>) which used to implement Resolver by SQL Types(queries, inserts, updates and deletes).</p>

<p>after resolving, the format of command looks like</p>

<div class="language-sql highlighter-rouge"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">Accounts</span><span class="p">.</span><span class="n">PRODUCT</span><span class="p">.</span><span class="n">ID</span><span class="p">,</span> <span class="n">Accounts</span><span class="p">.</span><span class="n">PRODUCT</span><span class="p">.</span><span class="n">SYMBOL</span><span class="p">,</span> <span class="n">Accounts</span><span class="p">.</span><span class="n">PRODUCT</span><span class="p">.</span><span class="n">COMPANY_NAME</span> <span class="k">FROM</span> <span class="n">Accounts</span><span class="p">.</span><span class="n">PRODUCT</span>
</code></pre>
</div>

<h3 id="validating---validate-sql-semantics-based-on-metadata-references-and-type-signatures"><strong>3. Validating</strong> - validate SQL semantics based on metadata references and type signatures.</h3>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">AbstractValidationVisitor</span> <span class="n">visitor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ValidationVisitor</span><span class="o">();</span>
<span class="n">ValidatorReport</span> <span class="n">report</span> <span class="o">=</span> <span class="n">Validator</span><span class="o">.</span><span class="na">validate</span><span class="o">(</span><span class="n">command</span><span class="o">,</span> <span class="n">metadata</span><span class="o">,</span> <span class="n">visitor</span><span class="o">);</span>
</code></pre>
</div>

<p>A <code class="highlighter-rouge">org.teiid.query.validator.ValidationVisitor</code> is used in Validating, ValidatorReport contain result of Validating.</p>

<h3 id="rewriting---rewrite-sql-to-simplify-expressions-and-criteria"><strong>4. Rewriting</strong> - rewrite SQL to simplify expressions and criteria</h3>

<p><code class="highlighter-rouge">QueryRewriter</code> is used,</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">QueryRewriter</span><span class="o">.</span><span class="na">rewrite</span><span class="o">(</span><span class="n">command</span><span class="o">,</span> <span class="n">metadata</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>
</code></pre>
</div>

<p>The aim of Rewriting is rewrite commands and command fragments to a form that is better for planning and execution. For example, language object From’s clauses list not setted by default, Rewriting will do it.</p>

<h3 id="optimizing---the-logical-plan-and-processor-plan"><strong>5. Optimizing</strong> - the logical plan and processor plan</h3>

<p><img src="/assets/blog/teiid-seq-generatePlan.png" alt="generate ProcessorPlan" /></p>

<p>As figure, QueryOptimizer’s optimizePlan() method is the entrence of Optimizing, the main of Optimizing has three primary phases:</p>

<ol>
  <li>Generate canonical plan</li>
  <li>Optimization</li>
  <li>Plan to process converter - converts plan data structure into a processing form</li>
</ol>

<blockquote>
  <p>NOTE: Phase 1 create a logical plan, Phase 2 update logical plan, Phase 3 convert logical plan to processor plan.</p>
</blockquote>

<h4 id="generate-canonical-plan">Generate canonical plan</h4>

<p>This step will convert internal <a href="http://ksoong.org/teiid-query-sql-api">Command</a> to a <a href="#PlanNode">PlanNode</a>.</p>

<p>With sql <code class="highlighter-rouge">SELECT ID, SYMBOL, COMPANY_NAME FROM Product</code>, the relevant Canonical Plan like</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">Project</span><span class="o">(</span><span class="n">groups</span><span class="o">=[</span><span class="n">Accounts</span><span class="o">.</span><span class="na">PRODUCT</span><span class="o">],</span> <span class="n">props</span><span class="o">={</span><span class="n">PROJECT_COLS</span><span class="o">=[</span><span class="n">Accounts</span><span class="o">.</span><span class="na">PRODUCT</span><span class="o">.</span><span class="na">ID</span><span class="o">,</span> <span class="n">Accounts</span><span class="o">.</span><span class="na">PRODUCT</span><span class="o">.</span><span class="na">SYMBOL</span><span class="o">,</span> <span class="n">Accounts</span><span class="o">.</span><span class="na">PRODUCT</span><span class="o">.</span><span class="na">COMPANY_NAME</span><span class="o">]})</span>
  <span class="n">Source</span><span class="o">(</span><span class="n">groups</span><span class="o">=[</span><span class="n">Accounts</span><span class="o">.</span><span class="na">PRODUCT</span><span class="o">])</span>
</code></pre>
</div>

<p>Refer to <a href="http://ksoong.org/teiid-planning#direct-query-source-model-accounts">Direct Query Source Model Accounts</a> for more details.</p>

<p>If Show Plan and Debug level logging be enabled, Generate canonical plan log can be found like</p>

<p><img src="/assets/blog/teiid-plan-canonicalplan.png" alt="canonical plan" /></p>

<h4 id="optimization">Optimization</h4>

<p>The further Optimizing, all changes are add on <a href="#PlanNode">PlanNode</a>, two steps involved: build a LIFO Rules stack and execute Rules.</p>

<p>Each rules in stack implement <code class="highlighter-rouge">org.teiid.query.optimizer.relational.OptimizerRule</code>,</p>

<p><a href="http://ksoong.org/teiid-uml-diagram#orgteiidqueryoptimizerrelationaloptimizerrule">UML of Rules</a></p>

<p>since Teiid 8.13, there are 28 rules existed. But with sql <code class="highlighter-rouge">SELECT ID, SYMBOL, COMPANY_NAME FROM Product</code>, the relevant LIFO Rules stack like</p>

<p><img src="/assets/blog/teiid-plan-lifo-stack.png" alt="lifo rule stack" /></p>

<p>Only 6 rules be pushed to Statck, then rules in Stack executed in a LIFO order as below:</p>

<p><strong>1. EXECUTING PlaceAccess</strong> - places access nodes under source nodes. An access node represents the point at which everything below the access node gets pushed to the source or is a plan invocation. Later rules focus on either pushing under the access or pulling the access node up the tree to move more work down to the sources. This rule is also responsible for placing <a href="https://teiid.gitbooks.io/documents/content/reference/Federated_Optimizations.html#_access_patterns">Access Patterns</a></p>

<p>Implementation class: <code class="highlighter-rouge">org.teiid.query.optimizer.relational.rules.RulePlaceAccess</code>.</p>

<p>Execution log:</p>

<p><img src="/assets/blog/teiid-plan-planaccess.png" alt="EXECUTING PlaceAccess" /></p>

<p><strong>2. EXECUTING RaiseAccess</strong> - this rule attempts to raise the Access nodes as far up the plan as possible. This is mostly done by looking at the source’s capabilities and determining whether the operations can be achieved in the source or not.</p>

<p>Implementation class: <code class="highlighter-rouge">org.teiid.query.optimizer.relational.rules.RuleRaiseAccess</code>.</p>

<p>Execution log:</p>

<p><img src="/assets/blog/teiid-plan-raiseaccess.png" alt="EXECUTING RaiseAccess log" /></p>

<p><strong>3. EXECUTING AssignOutputElements</strong> - this rule walks top down through every node and calculates the output columns for each node. Columns that are not needed are dropped at every node, which is known as projection minimization.  This is done by keeping track of both the columns needed to feed the parent node and also keeping track of columns that are “created” at a certain node.</p>

<p>Implementation class: <code class="highlighter-rouge">org.teiid.query.optimizer.relational.rules.RuleAssignOutputElements</code>.</p>

<p>Execution log:</p>

<p><img src="/assets/blog/teiid-plan-AssignOutputElements.png" alt="EXECUTING AssignOutputElements log" /></p>

<p><strong>4. EXECUTING CalculateCost</strong> - adds costing information to the plan.</p>

<p>Implementation class: <code class="highlighter-rouge">org.teiid.query.optimizer.relational.rules.RuleCalculateCost</code>.</p>

<p>Execution log:</p>

<p><img src="/assets/blog/teiid-plan-CalculateCost.png" alt="EXECUTING CalculateCost log" /></p>

<p><strong>5. EXECUTING PlanSorts</strong> - optimizations around sorting, such as combining sort operations or moving projection.</p>

<p>Implementation class: <code class="highlighter-rouge">org.teiid.query.optimizer.relational.rules.RulePlanSorts</code>.</p>

<p>Execution log:</p>

<p><img src="/assets/blog/teiid-plan-PlanSorts.png" alt="EXECUTING PlanSorts log" /></p>

<p><strong>6. EXECUTING CollapseSource</strong> - takes all of the nodes below an access node and creates a SQL query representation.</p>

<p>Implementation class: <code class="highlighter-rouge">org.teiid.query.optimizer.relational.rules.RuleCollapseSource</code>.</p>

<p>Execution log:</p>

<p><img src="/assets/blog/teiid-plan-CollapseSource.png" alt="EXECUTING CollapseSource log" /></p>

<blockquote>
  <p>NOTE: so far, the <a href="#PlanNode">PlanNode</a> be updated completely, rule-based optimization finished. Run <a href="https://raw.githubusercontent.com/kylinsoong/teiid-test/master/embedded/src/main/java/org/teiid/test/embedded/plan/PortfolioQueryPlanner.java">PortfolioQueryPlanner</a> as java Application will simulate these steps.</p>
</blockquote>

<h4 id="plan-to-process-converter">Plan to process converter</h4>

<p>Produces a ProcessorPlan(<a href="http://ksoong.org/teiid-uml-diagram#orgteiidqueryprocessorprocessorplan">UML diagram</a>) from above <a href="#PlanNode">PlanNode</a> via a PlanToProcessConverter, eg:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">PlanToProcessConverter</span> <span class="n">planToProcessConverter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PlanToProcessConverter</span><span class="o">(</span><span class="n">metadata</span><span class="o">,</span> <span class="n">idGenerator</span><span class="o">,</span> <span class="n">analysisRecord</span><span class="o">,</span> <span class="n">capFinder</span><span class="o">,</span> <span class="n">context</span><span class="o">);</span>
<span class="n">PlanNode</span> <span class="n">plan</span> <span class="o">=</span> <span class="n">generatePlan</span><span class="o">(</span><span class="n">command</span><span class="o">);</span>
<span class="n">RelationalPlan</span> <span class="n">result</span> <span class="o">=</span> <span class="n">planToProcessConverter</span><span class="o">.</span><span class="na">convert</span><span class="o">(</span><span class="n">plan</span><span class="o">);</span>
</code></pre>
</div>

<p><a href="#PlanNode">PlanNode</a> be firstly convert to Process Tree, a AccessNode(<a href="http://ksoong.org/teiid-uml-diagram#orgteiidqueryprocessorrelationalaccessnode">UML</a>), debug logs like</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="o">============================================================================</span>
<span class="n">CONVERTING</span> <span class="n">PLAN</span> <span class="n">TREE</span> <span class="n">TO</span> <span class="n">PROCESS</span> <span class="n">TREE</span>

<span class="n">PROCESS</span> <span class="n">PLAN</span> <span class="o">=</span>
<span class="n">AccessNode</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="n">output</span><span class="o">=[</span><span class="n">Accounts</span><span class="o">.</span><span class="na">PRODUCT</span><span class="o">.</span><span class="na">ID</span><span class="o">,</span> <span class="n">Accounts</span><span class="o">.</span><span class="na">PRODUCT</span><span class="o">.</span><span class="na">SYMBOL</span><span class="o">,</span> <span class="n">Accounts</span><span class="o">.</span><span class="na">PRODUCT</span><span class="o">.</span><span class="na">COMPANY_NAME</span><span class="o">]</span> <span class="n">SELECT</span> <span class="n">g_0</span><span class="o">.</span><span class="na">ID</span><span class="o">,</span> <span class="n">g_0</span><span class="o">.</span><span class="na">SYMBOL</span><span class="o">,</span> <span class="n">g_0</span><span class="o">.</span><span class="na">COMPANY_NAME</span> <span class="n">FROM</span> <span class="n">Accounts</span><span class="o">.</span><span class="na">PRODUCT</span> <span class="n">AS</span> <span class="n">g_0</span>

<span class="o">============================================================================</span>
</code></pre>
</div>

<p>The AccessNote be used as root for a Processor Plan, the final Processor Plan looks</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="o">----------------------------------------------------------------------------</span>
<span class="n">OPTIMIZATION</span> <span class="nl">COMPLETE:</span>
<span class="n">PROCESSOR</span> <span class="nl">PLAN:</span>
<span class="n">AccessNode</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="n">output</span><span class="o">=[</span><span class="n">Accounts</span><span class="o">.</span><span class="na">PRODUCT</span><span class="o">.</span><span class="na">ID</span><span class="o">,</span> <span class="n">Accounts</span><span class="o">.</span><span class="na">PRODUCT</span><span class="o">.</span><span class="na">SYMBOL</span><span class="o">,</span> <span class="n">Accounts</span><span class="o">.</span><span class="na">PRODUCT</span><span class="o">.</span><span class="na">COMPANY_NAME</span><span class="o">]</span> <span class="n">SELECT</span> <span class="n">g_0</span><span class="o">.</span><span class="na">ID</span><span class="o">,</span> <span class="n">g_0</span><span class="o">.</span><span class="na">SYMBOL</span><span class="o">,</span> <span class="n">g_0</span><span class="o">.</span><span class="na">COMPANY_NAME</span> <span class="n">FROM</span> <span class="n">Accounts</span><span class="o">.</span><span class="na">PRODUCT</span> <span class="n">AS</span> <span class="n">g_0</span>

<span class="o">============================================================================</span>
</code></pre>
</div>

<h3 id="plannode">PlanNode</h3>

<p>A <code class="highlighter-rouge">PlanNode</code> mainly consist of 3 parts: type, parent <code class="highlighter-rouge">PlanNode</code> and children <code class="highlighter-rouge">PlanNode</code> list.</p>

<p>There are 12 exist types for each <code class="highlighter-rouge">PlanNode</code>:</p>

<ol>
  <li><strong>NO_TYPE</strong></li>
  <li><strong>ACCESS</strong></li>
  <li><strong>DUP_REMOVE</strong></li>
  <li><strong>JOIN</strong></li>
  <li><strong>PROJECT</strong></li>
  <li><strong>SELECT</strong></li>
  <li><strong>SORT</strong></li>
  <li><strong>SOURCE</strong></li>
  <li><strong>GROUP</strong></li>
  <li><strong>SET_OP</strong></li>
  <li><strong>NULL</strong></li>
  <li><strong>TUPLE_LIMIT</strong></li>
</ol>

<p>A factory class <code class="highlighter-rouge">NodeFactory</code> can create a new PlanNode, the following is a example:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">PlanNode</span> <span class="n">node</span> <span class="o">=</span> <span class="n">NodeFactory</span><span class="o">.</span><span class="na">getNewNode</span><span class="o">(</span><span class="n">NodeConstants</span><span class="o">.</span><span class="na">Types</span><span class="o">.</span><span class="na">SOURCE</span><span class="o">);</span>
<span class="n">node</span><span class="o">.</span><span class="na">addGroup</span><span class="o">(</span><span class="k">new</span> <span class="n">GroupSymbol</span><span class="o">(</span><span class="s">"Accounts.PRODUCT"</span><span class="o">));</span>
</code></pre>
</div>

<p>the output of <code class="highlighter-rouge">PlanNode</code> looks</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">Source</span><span class="o">(</span><span class="n">groups</span><span class="o">=[</span><span class="n">Accounts</span><span class="o">.</span><span class="na">PRODUCT</span><span class="o">])</span>
</code></pre>
</div>

<p>A Editor class <code class="highlighter-rouge">NodeEditor</code> can find Child Node from a root Node. eg:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">List</span><span class="o">&lt;</span><span class="n">PlanNode</span><span class="o">&gt;</span> <span class="n">nodes</span> <span class="o">=</span> <span class="n">NodeEditor</span><span class="o">.</span><span class="na">findAllNodes</span><span class="o">(</span><span class="n">plan</span><span class="o">,</span> <span class="n">NodeConstants</span><span class="o">.</span><span class="na">Types</span><span class="o">.</span><span class="na">PROJECT</span> <span class="o">|</span> <span class="n">NodeConstants</span><span class="o">.</span><span class="na">Types</span><span class="o">.</span><span class="na">SOURCE</span><span class="o">)</span>
</code></pre>
</div>

<blockquote>
  <p>NOTE: The <code class="highlighter-rouge">PlanNode</code> in this section is under <code class="highlighter-rouge">org.teiid.query.optimizer.relational.plantree</code>, which different with <code class="highlighter-rouge">org.teiid.client.plan.PlanNode</code>.</p>
</blockquote>

<h2 id="batchcollector">BatchCollector</h2>

<p>BatchCollector used to extract TupleBatchs from DataSources and manipulate to a TupleBuffer, as below sequence diagram, BatchCollector mainly contains 3 aspects function:</p>

<p><img src="/assets/blog/teiid-BatchCollector-functionaity.png" alt="BatchCollector" /></p>

<ol>
  <li>Start Source Query Threads to return a FutureTask which bound a <code class="highlighter-rouge">AtomicResultsMessage</code>(1 -&gt; 2 -&gt; 3 -&gt; 4 -&gt; 5 -&gt; 6 -&gt; 7 -&gt; 8 -&gt;9).</li>
  <li>Check the FutureTask, get the Tuples from <code class="highlighter-rouge">AtomicResultsMessage</code>, assemble all Tuples to a TupleBatch(10 -&gt; 11 -&gt; 12 -&gt; 13 -&gt; 14).</li>
  <li>Manipulate TupleBatchs to a TupleBuffer(15 -&gt; 16).</li>
</ol>

<h3 id="process-system-query">Process System Query</h3>

<p>As <strong>Appendix-1</strong>, the usual processing procedures are like: create a <code class="highlighter-rouge">AtomicRequestMessage</code>, check the Cache, create a <code class="highlighter-rouge">DataTierTupleSource</code>, but if modelName parameter is <strong>SYS</strong> or <strong>SYSADMIN</strong>, the processing directly goes into <code class="highlighter-rouge">processSystemQuery</code>.</p>

<h3 id="blockedexception">BlockedException</h3>

<p>BlockedException is Teiid’s way to release the current thread instead of waiting for a processing resource to complete, like waiting for data from a data source. As above sequence diagram <strong>Appendix-3</strong> in DataTierTupleSource’s asynchGet() method, check the futureResult</p>

<ul>
  <li>If futureResult not done throw <code class="highlighter-rouge">BlockedException</code>, release current thread</li>
  <li>If futureResult done, get <code class="highlighter-rouge">AtomicResultsMessage</code> as result return</li>
</ul>

<p>The reference source code looks:</p>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="k">if</span> <span class="o">(!</span><span class="n">futureResult</span><span class="o">.</span><span class="na">isDone</span><span class="o">())</span> <span class="o">{</span>
	<span class="k">throw</span> <span class="n">BlockedException</span><span class="o">.</span><span class="na">block</span><span class="o">(</span><span class="n">aqr</span><span class="o">.</span><span class="na">getAtomicRequestID</span><span class="o">(),</span> <span class="s">"Blocking on source query"</span><span class="o">,</span> <span class="n">aqr</span><span class="o">.</span><span class="na">getAtomicRequestID</span><span class="o">());</span> <span class="c1">//$NON-NLS-1$</span>
<span class="o">}</span>
<span class="n">FutureWork</span><span class="o">&lt;</span><span class="n">AtomicResultsMessage</span><span class="o">&gt;</span> <span class="n">currentResults</span> <span class="o">=</span> <span class="n">futureResult</span><span class="o">;</span>
<span class="n">futureResult</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="n">AtomicResultsMessage</span> <span class="n">results</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="k">try</span> <span class="o">{</span>
	<span class="n">results</span> <span class="o">=</span> <span class="n">currentResults</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
</code></pre>
</div>

<p>The above code copy from <a href="https://raw.githubusercontent.com/teiid/teiid/master/engine/src/main/java/org/teiid/dqp/internal/process/DataTierTupleSource.java">DataTierTupleSource’s</a> asynchGet() method.</p>

<blockquote>
  <p>NOTE: <code class="highlighter-rouge">DataTierTupleSource</code> are the interactive layer used to interact with Connect layer, which connects, loads the data source.</p>
</blockquote>

<blockquote>
  <p>NOTE:  Asynch Query related with a FutureResult.</p>
</blockquote>

<h2 id="requestworkitem">RequestWorkItem</h2>

<p><a href="http://ksoong.org/teiid-uml-diagram">RequestWorkItem</a> implements <code class="highlighter-rouge">Runnable</code> interface, it be executed by Processing threads in processWorkerPool(more details about thread pool refer to <a href="#Threads in Teiid Engine">Threads in Teiid Engine</a> below). The main functionality supplied by <a href="http://ksoong.org/teiid-uml-diagram">RequestWorkItem</a> including:</p>

<ol>
  <li>Compiles results for the client</li>
  <li>Collects Tuples froming batchs</li>
  <li>Prevents buffer growth</li>
</ol>

<p><strong>Attributes of RequestWorkItem</strong>:</p>

<p><img src="/assets/blog/teiid-requestWorkItem-attr.png" alt="RequestWorkItem run" /></p>

<h3 id="threads-in-teiid-engine">Threads in Teiid Engine</h3>

<p>There are 3 kinds of threads:</p>

<p><img src="/assets/blog/teiid-engine-threads.png" alt="Teiid Engine Threads" /></p>

<ul>
  <li>
    <p><strong>Netty Worker Threads</strong> - the work related with Engine Process are execute DQPCore’s executeRequest() method, init the <code class="highlighter-rouge">Request</code> and <code class="highlighter-rouge">RequestWorkItem</code>, then start the <code class="highlighter-rouge">RequestWorkItem</code> which wrapped a active processor plan.</p>
  </li>
  <li>
    <p><strong>Process Worker Threads</strong> - <a href="http://ksoong.org/teiid-uml-diagram">RequestWorkItem</a>, run the process request, rule-based optimization, etc. processWorkerPool used maintain these threads, the init of the processWorkerPool like:</p>
  </li>
</ul>

<div class="language-java highlighter-rouge"><pre class="highlight"><code><span class="n">ThreadPoolExecutor</span> <span class="n">tpe</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ThreadPoolExecutor</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">,</span> <span class="k">new</span> <span class="n">SynchronousQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;(),</span> <span class="k">new</span> <span class="n">NamedThreadFactory</span><span class="o">(</span><span class="s">"Worker"</span><span class="o">));</span>
</code></pre>
</div>

<ol>
  <li>corePoolSize is 0 means the processWorkerPool do not keep any idle threads</li>
  <li>maximumPoolSize is 2147483647 means the maximum number of threads to allow in pool is 2147483647.</li>
  <li>keepAliveTime is 2 and time unit is minutes means the idle threads will be keep 2 minutes then be excess</li>
</ol>

<ul>
  <li><strong>Source Query Worker Threads</strong> - Used to retrive tuple’s from DataSources, interacted with Connector layer(translator and resource adapter) via <a href="http://ksoong.org/teiid-uml-diagram#orgteiiddqpinternaldatamgrconnectorwork">ConnectorWork</a> API. Learn more from <a href="http://ksoong.org/teiid-s-diagram#datatiertuplesource-getresults">sequence diagram</a>. Source Query Worker Threads also maintained by processWorkerPool.</li>
</ul>

<h3 id="send-results-if-needed">send Results If Needed</h3>

<p>This should only be called from Process Worker Threads, ResultsReceiver’s receiveResults(T results) method be invoked, set the results to <code class="highlighter-rouge">org.teiid.client.util.ResultsFuture</code>’s result if they have been requested.</p>

<h3 id="threadstate-change-change-in-request-processing">ThreadState Change Change in Request Processing</h3>

<p><img src="/assets/blog/teiid/teiid-processing-threadstate.png" alt="Teiid ThreadState" /></p>

<p><strong>Rules of ThreadState Change</strong></p>

<p><strong>1.</strong> Process Threads startProcessing change ThreadState from <strong>MORE_WORK</strong> to <strong>WORKING</strong></p>

<p>Any threads start execute the RequestWorkItem, its ThreadState Must be <strong>MORE_WORK</strong>, then change to <strong>WORKING</strong></p>

<p><strong>2.</strong> Process Threads endProcessing change ThreadState to <strong>DONE</strong> or <strong>IDLE</strong></p>

<ul>
  <li>if RequestWorkItem’s ThreadState is <strong>WORKING</strong> and Processing is Done, change ThreadState to <strong>DONE</strong></li>
  <li>if RequestWorkItem’s ThreadState is <strong>WORKING</strong> and Processing is NOT Done, change ThreadState to <strong>IDLE</strong></li>
  <li>if RequestWorkItem’s ThreadState is <strong>MORE_WORK</strong> and Processing is Done, change ThreadState to <strong>DONE</strong></li>
</ul>

<p><strong>3.</strong> moreWork() method change ThreadState to <strong>MORE_WORK</strong></p>

<p>Both Query Thread and Close Request Thread will invoke RequestWorkItem’s <code class="highlighter-rouge">moreWork()</code>, change ThreadState to <strong>MORE_WORK</strong>:</p>

<ul>
  <li>Query Threads invoke moreWork() - Once Query Thread finished Query(If DataTierTupleSource’s <code class="highlighter-rouge">cancelAsynch</code> is false, or If RequestWorkItem’s <code class="highlighter-rouge">isProcessing</code> is true) execute RequestWorkItem’s <code class="highlighter-rouge">moreWork()</code>, and if ThreadState is <strong>WORKING</strong> or <strong>IDLE</strong>, change to <strong>MORE_WORK</strong></li>
  <li>Close Request Thread invoke moreWork() - Once RequestWorkItem’s <code class="highlighter-rouge">requestClose()</code>request, it will execute RequestWorkItem’s <code class="highlighter-rouge">moreWork()</code>, and if ThreadState is <strong>WORKING</strong> or <strong>IDLE</strong>, change to <strong>MORE_WORK</strong></li>
</ul>



<br/>
<ul class="btn pull-right">
<div class="bdsharebuttonbox">
  <a href="#" class="bds_more" data-cmd="more"></a>
  <a title="分享到QQ空间" href="#" class="bds_qzone" data-cmd="qzone"></a>
  <a title="分享到新浪微博" href="#" class="bds_tsina" data-cmd="tsina"></a>
  <a title="分享到腾讯微博" href="#" class="bds_tqq" data-cmd="tqq"></a>
  <a title="分享到人人网" href="#" class="bds_renren" data-cmd="renren"></a>
  <a title="分享到微信" href="#" class="bds_weixin" data-cmd="weixin"></a>
</div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"分享ksoong.org的文章「Understanding Teiid Engine」 - ksoong.org","bdDesc":"","bdMini":"2","bdPic":"","bdStyle":"0","bdSize":"16"},"share":{},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["qzone","tsina","tqq","renren","weixin"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
</ul>

<div class="ds-thread" data-thread-key="ksoong2015052501" data-title="Understanding Teiid Engine" data-url="snail.ren/teiid-dqp"></div>

	    <ul class="pager">
		
		<li class="previous"><a href="/teiid-uml-diagram">&laquo;&nbsp;Teiid Code Analysis - UML...</a></li>
		
		
		<li class="next"><a href="/teiid-mat-view">Teiid Materialized Views&nbsp;&raquo;</a></li>
		
	    </ul>


        </div>
        <aside id="sidebar" role="complementary">
          <div class="subscribe">
            <h2 class="icon news">
              <a href="/feed.xml">Subscribe</a>
            </h2>
          </div>
          <nav class="latest">
            <h2>Latest Posts</h2>
            <ul>
            
              <li>
                <div class="title">
                  <a href="/wfl-ds">WildFly Data Sources Configuration</a>
                </div>
                <div class="meta">
                  Apr 26, 2016
                </div>
              </li>
             
              <li>
                <div class="title">
                  <a href="/teiid-transactions">Transaction in Teiid</a>
                </div>
                <div class="meta">
                  Apr 20, 2016
                </div>
              </li>
             
              <li>
                <div class="title">
                  <a href="/teiid-getstart-code">Get Start Teiid From Source...</a>
                </div>
                <div class="meta">
                  Apr 7, 2016
                </div>
              </li>
             
              <li>
                <div class="title">
                  <a href="/teiid-metadata">Understanding Teiid Metadata</a>
                </div>
                <div class="meta">
                  Mar 27, 2016
                </div>
              </li>
             
              <li>
                <div class="title">
                  <a href="/rhel7-commands">Linux 命令集合</a>
                </div>
                <div class="meta">
                  Mar 17, 2016
                </div>
              </li>
             
            </ul>
            
                        
          </nav>
          <nav class="tags">
            <h2>Categories</h2>
            <div class="tag-cloud">
              
              <span class="tag tag-1">
                <a href="/categories/jekyll">Jekyll(6)</a>
              </span>
              
              <span class="tag tag-1">
                <a href="/categories/jboss">Jboss(24)</a>
              </span>
              
              <span class="tag tag-1">
                <a href="/categories/java">Java(18)</a>
              </span>
              
              <span class="tag tag-1">
                <a href="/categories/css">Css(1)</a>
              </span>
              
              <span class="tag tag-1">
                <a href="/categories/database">Database(6)</a>
              </span>
              
              <span class="tag tag-1">
                <a href="/categories/javaee">Javaee(11)</a>
              </span>
              
              <span class="tag tag-1">
                <a href="/categories/linux">Linux(2)</a>
              </span>
              
              <span class="tag tag-1">
                <a href="/categories/teiid">Teiid(40)</a>
              </span>
              
              <span class="tag tag-1">
                <a href="/categories/maven">Maven(2)</a>
              </span>
              
              <span class="tag tag-1">
                <a href="/categories/netty">Netty(7)</a>
              </span>
              
              <span class="tag tag-1">
                <a href="/categories/data">Data(24)</a>
              </span>
              
              <span class="tag tag-1">
                <a href="/categories/git">Git(2)</a>
              </span>
              
              <span class="tag tag-1">
                <a href="/categories/other">Other(11)</a>
              </span>
              
              <span class="tag tag-1">
                <a href="/categories/performance">Performance(4)</a>
              </span>
              
              <span class="tag tag-1">
                <a href="/categories/security">Security(3)</a>
              </span>
              
              <span class="tag tag-1">
                <a href="/categories/docker">Docker(4)</a>
              </span>
              
              
            </div>
          </nav>
        </aside>
      </div>


    </div>
    <footer>
      <div class="container">
        <div class="project">
          <p class="bottom">
            ©
            Copyright 2009-2016 ksoong.
            <br>
            <i class="icon-fire"></i>
            Mixed with <a href="http://twitter.github.com/bootstrap">Bootstrap</a>.
            <br>
            <i class="icon-share-alt"></i>
            Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>.
            <br>
            Code released under <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, v2.0</a>.
          </p>
        </div>
        <div class="footer-nav">
          <h4>Learn</h4>
          <ul>
            <li>
              <a href="http://www.jboss.org/">JBoss</a>
            </li>
            <li>
              <a href="http://infinispan.org/">Infinispan</a>
            </li>
            <li>
              <a href="http://teiid.org/">Teiid</a>
            </li>
            <li>
              <a href="https://github.com/kylinsoong">Github</a>
            </li>
          </ul>
        </div>
        
        <div class="sponser">
          <div class="follow-us">
            <h4>Stay Informed</h4>
            <ul>
              <li>
                <a href="https://plus.google.com/103933729718268414460?rel=author"><img alt="Google+" src="/css/googleplus-16.png" title="Follow ksoong.org on Google+"></a>
              </li>
              <li>
                <a href="http://www.weibo.com/kylinsoong"><img alt="Weibo" src="/css/weibo_logo.jpg" title="Follow me on Weibo"></a>
              </li>
	      <li>
                <a href="https://github.com/kylinsoong"><img alt="Github" src="/css/Octocat.jpg" title="Fork me on Github"></a>
              </li>

            </ul>
          </div>
        </div>
        <a class="visible-desktop" href="#" id="toTop">Top</a>
      </div>
        <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1258751305'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s4.cnzz.com/z_stat.php%3Fid%3D1258751305%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));</script>
    </footer>
  
 
    <script src="/css/jquery-1.11.1.min.js"></script>
    <script src="/css/bootstrap.js"></script>

   <script>
      $(function() {
        $('html').addClass('ready');
        prettify();
        activateFooterGravity();
        activateTooltips();
        activateToTopControl();
      });
    </script>
    <script src="/css/site.js"></script>

    
            
            <script type="text/javascript">
                var duoshuoQuery = {short_name:"ksoong"};
                (function() {
                    var ds = document.createElement('script');
                    ds.type = 'text/javascript';
                    ds.async = true;
                    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
                    ds.charset = 'UTF-8';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds);
                })();
            </script>
            
        


</body>
</html>
